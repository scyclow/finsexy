<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>FinSexy</title>
  <link rel="shortcut icon" type="image/x-icon" href="./assets/kiss.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="">
  <meta name="keywords" content="steviep, steve pikelny, pikelny, crypto, ethereum, bitcoin">

  <meta name="twitter:image" content="https://steviep.xyz/">
  <meta name="twitter:image:alt" content="">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steviepxyz">
  <meta name="twitter:site" content="@steviepxyz">
  <meta property="twitter:description" content="">

  <meta name="og:image" property="og:image" content="https://steviep.xyz/">
  <meta name="og:image:alt" content="">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://steviep.xyz/">
  <meta property="og:title" content="">
  <meta property="og:site_name" content="">
  <meta property="og:description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">


  <link rel="stylesheet" type="text/css" href="./styles.css">

  <style type="text/css">

    #messageSelector .active {
      background: var(--primary-color);
      color: var(--light-color);
    }

    #messageSelector {
      list-style-type: none;
    }
    #messageSelector li {
      cursor: pointer;
      border: 1px solid var(--border-color);
      padding: 1em;
      transition: 0.2s;
    }
    #messageSelector li:hover {
      background: var(--medium-color);
    }
    #messageSelector .active:hover {
      background: var(--medium-color);
    }

    .chat-window.display-none {
      display: none;
    }

    .chat-window {
      height: calc(100% - 2px);
    }

    #chatWindow {
      /*width: 100%;*/
      flex:  1;
    }

    .devPanel {
      width: 30vw;
      overflow: scroll;
      display: none;
    }

    .__debug .devPanel {
      display: initial;
    }

    main {
      display: flex;
      height: calc(100% - 60px);
    }


    code, code * {
      font-family: monospace;
    }

    @media (max-width: 600px) {
      main {
        flex-direction: column;
      }
    }

    body {
      height: 100vh;
      max-height: 100vh;
      flex-direction: column;
      display: flex;
    }

    .unread.hidden {
      visibility: hidden;
    }

    .unread {
      font-size: 0.75em;
      font-weight: bolder;

      height: 1em;
      width: 1em;
      padding: 0.5em;
      margin-left: 0.5em;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      border-radius: 50%;
      background: var(--primary-color);
      color: var(--light-color);

      transform: translateY(-.2em);
        box-shadow: 0 0 1em var(--primary-color)

    }

    .message-selector {
      display: flex;
      justify-content: space-between;
    }

  </style>
</head>
<body>
  <sexy-header style="flex: 1"></sexy-header>
  <main>
    <aside>
      <!-- <message-selector id="messageSelector"></message-selector> -->
      <ul id="messageSelector"></ul>
    </aside>

    <section id="chatWindow">

    </section>

    <aside class="devPanel">
      <h1>Dev Panel</h1>
      <code>
        <pre id="chatState">

        </pre>
      </code>
    </aside>

  </main>



</body>


<script src="./utils.js"></script>
<script type="module" src="./state/all.js"></script>
<script type="module" src="./components/all.js"></script>




<script type="module">
  import {MessageHandler} from './state/all.js'
  import {$, queryParams} from './$.js'

  const $messageSelector = $.id('messageSelector')
  const $chatWindow = $.id('chatWindow')


  const messageNames = Object.keys(MessageHandler.chats)

  $messageSelector.innerHTML = messageNames.map(name => `
    <li
      id="${name}-select"
      class="message-selector"
      onclick="onConvoSelect('${name}')"
    >
      ${name}
      <span id="${name}-unread" class="unread hidden"></span>
    </li>
  `).join('')


  $chatWindow.innerHTML = messageNames.map(name => `
    <chat-window id="${name}-chat" name="${name}" class="chat-window"></chat-window>
  `).join('')


  messageNames.forEach(name => {
    const $window = $.id(`${name}-chat`)
    MessageHandler.chats[name].addChatWindow($window)
  })


  $messageSelector.innerHTML += `
    <li>
      <button onclick="localStorage.removeItem('__CHAT_CONTEXT'); window.location.reload()">clear</button>
    </li>
  `


  let activeChat
  const onConvoSelect = (id, ignoreHistory=false) => {
    activeChat = id

    const activeChatWindow = $.id(id + '-chat')

    $.cls('message-selector').forEach(ms => {
      ms.classList.remove('active')
    })

    $.cls('chat-window').forEach(cw => {
      cw.classList.add('display-none')
    })

    $.id(id + '-select').classList.add('active')
    activeChatWindow.classList.remove('display-none')
    activeChatWindow.scroll()

    const url = new URL(window.location)
    url.searchParams.set('activeChat', activeChat)
    if (!ignoreHistory) window.history.pushState({}, '', url)

    Object.keys(MessageHandler.chats).forEach(k => {
      if (k === activeChat) {
        MessageHandler.chats[k].isActive = true
        MessageHandler.chats[k].ctx.resetUnread()
      } else {
        MessageHandler.chats[k].isActive = false
      }

    })
  }


  activeChat = Object.keys(MessageHandler.chats).includes(queryParams.activeChat)
    ? queryParams.activeChat
    : 'heatherHot'

  setTimeout(() => {
    onConvoSelect(activeChat, true)
  })

  setRunInterval(() => {
    const chat = MessageHandler.chats[activeChat]
    if (chat) {
      $.id('chatState').innerHTML = JSON.stringify(
        {...chat.ctx, history: chat.ctx.history},
        null,
        4
      )
    }

    $.id('chatState').innerHTML += Object.keys(MessageHandler.chats).map(m => {
      if (MessageHandler.chats[m]) {
        return `
          <div>${m}: ${MessageHandler.chats[m].ctx.unread}</div>
        `
      } else {
        return ''
      }
    }
    ).join('')

  }, 10)



  setInterval(() => {
    Object.keys(MessageHandler.chats).forEach(m => {
      const unread = $.id(`${m}-unread`)
      const unreadCount = MessageHandler.chats[m].ctx.unread
      if (unread && unreadCount) {
        unread.innerHTML = unreadCount
        unread.classList.remove('hidden')
      } else if (unread) {
        unread.innerHTML = ''
        unread.classList.add('hidden')
      }
    })
  }, 100)

  // $heatherHotSelect.onclick = () => {
  //   $heatherHotSelect.classList.add
  // }











</script>


























</html>